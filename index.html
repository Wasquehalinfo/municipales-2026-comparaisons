<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparatif des candidatures</title>

  <!-- CSV robuste + Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#12141b;
      --muted:#a9b4c3;
      --text:#eef3fb;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --max:1100px;

      /* Couleurs “douces” et neutres */
      --a:#52d6c8;   /* teal doux */
      --b:#b59cff;   /* violet doux */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: linear-gradient(180deg, #0b0c10 0%, #07080b 100%);
      color:var(--text);
      line-height: 1.5;
    }
    a{color:inherit}

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,12,16,.78);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .topbar{
      max-width:var(--max);
      margin:0 auto;
      padding:16px 16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    /* Typo plus grande */
    .title h1{
      margin:0;
      font-size: 20px;
      font-weight: 760;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      font-size: 14px;
      color: var(--muted);
    }

    .nav{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      font-size: 14px;
      text-decoration:none;
    }
    .chip:hover{border-color: rgba(255,255,255,.18)}

    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      font-size: 14px;
      cursor:pointer;
    }
    .seg button[aria-pressed="true"]{
      background: rgba(255,255,255,.08);
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:24px 16px 64px}

    /* Cartes candidat (en haut) */
    .candRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom: 16px;
    }
    .candCard{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(18,20,27,.85);
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .candCard::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(800px 200px at 20% 0%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .candHead{display:flex; align-items:baseline; justify-content:space-between; gap:10px}
    .candName{font-size:16px; font-weight:800; margin:0}
    .candList{font-size:14px; color:var(--muted); margin-top:4px}
    .badge{
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      padding:4px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.03);
    }
    .candA .candName{color: var(--a)}
    .candB .candName{color: var(--b)}

    /* Sections */
    .section{
      margin-top:18px;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sectionHead{
      padding:16px 16px 12px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .sectionHead h2{margin:0; font-size:18px}
    .hint{font-size:14px; color:var(--muted)}

    details{
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.01);
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:14px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sumTitle{font-weight:750; font-size:16px}
    .chev{opacity:.8}
    details[open] .chev{transform: rotate(180deg)}
    .topicBody{padding:0 16px 16px}

    /* Desktop: 2 colonnes */
    .compareGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 12px;
    }
    .colCard{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(18,20,27,.88);
      border-radius: 14px;
      padding: 12px;
    }
    .colHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .colName{font-weight:850; font-size:15px; margin:0}
    .colTag{font-size:13px; color:var(--muted); margin-top:2px}

    .items{display:flex; flex-direction:column; gap:10px}
    .item{
      padding:12px;
      border:1px solid rgba(255,255,255,.07);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      position: relative;
    }
    /* Accents couleur candidat (petite barre) */
    .itemA{border-left: 4px solid rgba(82,214,200,.55)}
    .itemB{border-left: 4px solid rgba(181,156,255,.55)}

    .itemTitle{font-size:14px; font-weight:850; margin:0 0 6px}
    .itemText{font-size:16px; margin:0; color:#e6eefc}
    .itemText p{margin:0}
    .src{margin-top:8px; font-size:13px; color:var(--muted)}
    .src a{color:inherit; text-decoration:underline; text-decoration-color: rgba(255,255,255,.35)}
    .src a:hover{text-decoration-color: rgba(255,255,255,.75)}

    /* Mobile: empiler + toggle */
    @media (max-width: 820px){
      .candRow{grid-template-columns:1fr}
      .compareGrid{grid-template-columns:1fr}
      .desktopOnly{display:none !important}
    }
    @media (min-width: 821px){
      .mobileOnly{display:none !important}
    }

    .singleView{display:grid; gap:12px; margin-top:12px}
    .rowCompare{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(18,20,27,.88);
      overflow:hidden;
    }
    .rowHead{
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
    }
    .rowHead strong{font-size:14px}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:4px 10px;
      border-radius:999px;
    }
    .rowBody{padding:12px}
    .rowLabel{font-size:14px; font-weight:850; margin:0 0 6px}
    .rowText{font-size:16px}
    .rowText p{margin:0}

    .loading{color:var(--muted); font-size:16px}
    .footerNote{margin-top:18px; font-size:14px; color:var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1 id="pageTitle">Comparatif des candidatures</h1>
      <div class="sub" id="pageSub">Chargement…</div>
    </div>

    <div class="nav">
      <a class="chip" href="#equipe">L’équipe</a>
      <a class="chip" href="#programme">Le programme</a>
      <a class="chip" href="#budget">Le budget</a>

      <div class="seg" role="group" aria-label="Affichage mobile">
        <button id="btnBoth" aria-pressed="true">Les deux</button>
        <button id="btnA" aria-pressed="false">A</button>
        <button id="btnB" aria-pressed="false">B</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <div class="loading">Chargement des données…</div>
</main>

<script>
/** ✅ Ton CSV Google Sheets publié */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbr3kE4RckddIXPH8F2EGSWeGmHmCcTs2SNM-WqYUNV1NgcSNEr_kdl3N-RBolLFofzZfBMd4LnzyJ/pub?output=csv";

/** Candidats (comme demandé) */
const CANDIDATES = {
  A: { name: "Benoit Tirmarche", tag: "Wasquehal Vivante" },
  B: { name: "Stéphanie Ducret", tag: "Wasquehal pour Tous" }
};

/** Les 3 parties fixes (ordre contrôlé ici) */
const PARTS = [
  { key: "equipe", id: "equipe", title: "L’équipe", hint: "Parcours, gouvernance, transparence" },
  { key: "programme", id: "programme", title: "Le programme", hint: "Problématiques par thèmes" },
  { key: "budget", id: "budget", title: "Le budget", hint: "Financement, priorités, investissements" },
];

let mobileMode = "both"; // "both" | "A" | "B"
function setPressed(id, pressed){ document.getElementById(id).setAttribute("aria-pressed", pressed ? "true" : "false"); }
function setMobileMode(mode){
  mobileMode = mode;
  setPressed("btnBoth", mode==="both");
  setPressed("btnA", mode==="A");
  setPressed("btnB", mode==="B");
  render(window.__MODEL__);
}
document.getElementById("btnBoth").addEventListener("click", () => setMobileMode("both"));
document.getElementById("btnA").addEventListener("click", () => setMobileMode("A"));
document.getElementById("btnB").addEventListener("click", () => setMobileMode("B"));

function esc(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* Markdown autorisé dans les cellules candidatA/candidatB */
function mdToHtml(s){ return marked.parse((s ?? "").toString()); }

function srcHtml(url){
  const u = (url || "").trim();
  if(!u) return "";
  const safe = esc(u).replaceAll('"',"&quot;");
  return `<div class="src">Source : <a href="${safe}" target="_blank" rel="noopener">${safe}</a></div>`;
}

function num(x, fallback=999){
  const n = parseFloat((x ?? "").toString().replace(",", "."));
  return Number.isFinite(n) ? n : fallback;
}

/**
 * CSV attendu (colonnes minimales) :
 * partie, sous_partie, item, candidatA, candidatB, sourceA, sourceB, ordre_sous_partie, ordre_item
 */
function normalizeRow(r){
  return {
    partie: (r.partie || "").trim().toLowerCase(),
    sous_partie: (r.sous_partie || "").trim(),
    item: (r.item || "").trim(),
    candidatA: (r.candidatA || "").trim(),
    candidatB: (r.candidatB || "").trim(),
    sourceA: (r.sourceA || "").trim(),
    sourceB: (r.sourceB || "").trim(),
    ordre_sous_partie: num(r.ordre_sous_partie, 999),
    ordre_item: num(r.ordre_item, 999),
  };
}

function buildModel(rows){
  // partKey -> sousPartKey -> items[]
  const partsMap = new Map();
  for(const p of PARTS){
    partsMap.set(p.key, { ...p, sous: new Map() });
  }

  for(const raw of rows){
    const r = normalizeRow(raw);
    if(!r.partie || !partsMap.has(r.partie)) continue;

    const part = partsMap.get(r.partie);
    const sp = r.sous_partie || "Divers";

    if(!part.sous.has(sp)){
      part.sous.set(sp, {
        title: sp,
        order: r.ordre_sous_partie,
        items: []
      });
    }

    part.sous.get(sp).items.push({
      label: r.item || "Élément",
      order: r.ordre_item,
      A: { text: r.candidatA, source: r.sourceA },
      B: { text: r.candidatB, source: r.sourceB },
    });
  }

  // Convert to arrays + sort
  const parts = PARTS.map(p => {
    const part = partsMap.get(p.key);
    const sousParts = Array.from(part.sous.values()).sort((a,b)=>{
      if(a.order !== b.order) return a.order - b.order;
      return a.title.localeCompare(b.title, "fr");
    });

    for(const sp of sousParts){
      sp.items.sort((a,b)=> a.order - b.order);
    }

    return { ...p, sousParts };
  });

  return {
    title: "Comparatif des candidatures",
    subtitle: "Mobile : bascule A / B / Les deux • Desktop : côte à côte",
    candidates: CANDIDATES,
    parts
  };
}

function render(model){
  const app = document.getElementById("app");
  if(!model){
    app.innerHTML = `<div class="loading">Aucune donnée.</div>`;
    return;
  }
  document.getElementById("pageTitle").textContent = model.title;
  document.getElementById("pageSub").textContent = model.subtitle;

  const {A, B} = model.candidates;

  const headerCards = `
    <div class="candRow">
      <div class="candCard candA">
        <div class="candHead">
          <div>
            <p class="candName">${esc(A.name)}</p>
            <div class="candList">${esc(A.tag)}</div>
          </div>
          <span class="badge">Candidat A</span>
        </div>
      </div>
      <div class="candCard candB">
        <div class="candHead">
          <div>
            <p class="candName">${esc(B.name)}</p>
            <div class="candList">${esc(B.tag)}</div>
          </div>
          <span class="badge">Candidate B</span>
        </div>
      </div>
    </div>
  `;

  const sectionsHtml = model.parts.map(part => {
    const sousHtml = (part.sousParts || []).map((sp, idx) => {
      const desktop = `
        <div class="compareGrid desktopOnly">
          <div class="colCard">
            <div class="colHead">
              <div>
                <div class="colName" style="color:var(--a)">${esc(A.name)}</div>
                <div class="colTag">${esc(A.tag)}</div>
              </div>
            </div>
            <div class="items">
              ${sp.items.map(it => `
                <div class="item itemA">
                  <p class="itemTitle">${esc(it.label)}</p>
                  <div class="itemText">${mdToHtml(it.A?.text || "")}</div>
                  ${srcHtml(it.A?.source)}
                </div>
              `).join("")}
            </div>
          </div>

          <div class="colCard">
            <div class="colHead">
              <div>
                <div class="colName" style="color:var(--b)">${esc(B.name)}</div>
                <div class="colTag">${esc(B.tag)}</div>
              </div>
            </div>
            <div class="items">
              ${sp.items.map(it => `
                <div class="item itemB">
                  <p class="itemTitle">${esc(it.label)}</p>
                  <div class="itemText">${mdToHtml(it.B?.text || "")}</div>
                  ${srcHtml(it.B?.source)}
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      `;

      const mobileBoth = `
        <div class="singleView mobileOnly" data-mode="both">
          ${sp.items.map(it => `
            <div class="rowCompare">
              <div class="rowHead">
                <strong>${esc(it.label)}</strong>
                <span class="pill">Comparer</span>
              </div>
              <div class="rowBody" style="display:grid;gap:12px;">
                <div>
                  <div class="rowLabel" style="color:var(--a)">${esc(A.name)}</div>
                  <div class="rowText">${mdToHtml(it.A?.text || "")}</div>
                  ${srcHtml(it.A?.source)}
                </div>
                <div>
                  <div class="rowLabel" style="color:var(--b)">${esc(B.name)}</div>
                  <div class="rowText">${mdToHtml(it.B?.text || "")}</div>
                  ${srcHtml(it.B?.source)}
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      `;

      const mobileSingle = (who) => {
        const name = who === "A" ? A.name : B.name;
        const color = who === "A" ? "var(--a)" : "var(--b)";
        return `
          <div class="singleView mobileOnly" data-mode="${who}">
            ${sp.items.map(it => `
              <div class="rowCompare">
                <div class="rowHead">
                  <strong>${esc(it.label)}</strong>
                  <span class="pill">${esc(name)}</span>
                </div>
                <div class="rowBody">
                  <div class="rowLabel" style="color:${color}">${esc(name)}</div>
                  <div class="rowText">${mdToHtml((who==="A" ? it.A?.text : it.B?.text) || "")}</div>
                  ${srcHtml((who==="A" ? it.A?.source : it.B?.source) || "")}
                </div>
              </div>
            `).join("")}
          </div>
        `;
      };

      const mobile = mobileMode === "both" ? mobileBoth : mobileSingle(mobileMode);

      return `
        <details ${idx===0 ? "open" : ""}>
          <summary>
            <div class="sumTitle">${esc(sp.title)}</div>
            <div class="chev">▾</div>
          </summary>
          <div class="topicBody">
            ${desktop}
            ${mobile}
          </div>
        </details>
      `;
    }).join("");

    return `
      <section class="section" id="${esc(part.id)}">
        <div class="sectionHead">
          <h2>${esc(part.title)}</h2>
          <div class="hint">${esc(part.hint || "")}</div>
        </div>
        ${sousHtml || `<div style="padding:16px;color:var(--muted);font-size:16px">Aucun élément pour cette partie.</div>`}
      </section>
    `;
  }).join("");

  app.innerHTML = headerCards + sectionsHtml + `
    <div class="footerNote">
      Astuce : sur mobile, utilise “A / B / Les deux” pour une comparaison confortable sans zoom.
      Le texte des candidats peut contenir du Markdown (ex: <code>**gras**</code>, <code>[lien](https://...)</code>).
    </div>
  `;

  // Affiche le bon mode mobile
  document.querySelectorAll('.mobileOnly[data-mode]').forEach(el => {
    el.style.display = (el.getAttribute('data-mode') === mobileMode) ? 'grid' : 'none';
  });
}

function loadFromCsv(){
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      const rows = results.data || [];
      const model = buildModel(rows);
      window.__MODEL__ = model;
      render(model);
    },
    error: (err) => {
      document.getElementById("app").innerHTML = `
        <div class="loading">
          Erreur de chargement CSV.<br/>
          Vérifie que le lien est bien public et au format <b>pub?output=csv</b>.
          <div style="margin-top:10px;color:var(--muted)">${esc(err?.message || "")}</div>
        </div>`;
    }
  });
}

loadFromCsv();
</script>
</body>
</html>
