<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparatif des candidatures</title>

  <!-- CSV robuste + Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      /* Fond clair */
      --bg:#ffffff;
      --text:#0f172a;      /* slate-900 */
      --muted:#475569;     /* slate-600 */
      --border:#e2e8f0;    /* slate-200 */
      --card:#ffffff;

      /* Accents candidats (doux, non politisés) */
      --a:#0f766e;         /* teal-700 */
      --aSoft:#ccfbf1;     /* teal-100 */
      --b:#6d28d9;         /* violet-700 */
      --bSoft:#ede9fe;     /* violet-100 */

      /* Accents sections */
      --secSoft:#f1f5f9;   /* slate-100 */

      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
      --max:1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--text);
      line-height: 1.55;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }

    .topbar{
      max-width:var(--max);
      margin:0 auto;
      padding:16px 16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .title h1{
      margin:0;
      font-size: 22px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      font-size: 15px;
      color: var(--muted);
    }

    .nav{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      border:1px solid var(--border);
      background: #fff;
      padding:10px 12px;
      border-radius:999px;
      font-size: 15px;
      text-decoration:none;
      color: var(--text);
    }
    .chip:hover{background: #f8fafc}

    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background: #fff;
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      font-size: 15px;
      cursor:pointer;
    }
    .seg button[aria-pressed="true"]{
      background: #f1f5f9;
      font-weight: 750;
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:24px 16px 64px}

    /* Cartes candidats */
    .candRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom: 18px;
    }
    .candCard{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .candHead{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .candName{font-size:18px; font-weight:900; margin:0}
    .candList{font-size:15px; color:var(--muted); margin-top:4px}
    .badge{
      font-size:12px;
      border:1px solid var(--border);
      padding:4px 10px;
      border-radius:999px;
      color: var(--muted);
      background: #fff;
      white-space:nowrap;
    }
    .candA{border-left: 6px solid var(--a)}
    .candB{border-left: 6px solid var(--b)}
    .candA .candName{color: var(--a)}
    .candB .candName{color: var(--b)}

    /* Grande section */
    .section{
      margin-top:18px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--card);
    }
    .sectionHead{
      padding:18px 16px;
      border-bottom:1px solid var(--border);
      background: var(--secSoft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sectionHead h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sectionMark{
      display:flex; gap:8px; align-items:center;
      font-size:13px; color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(2,6,23,.1);
    }
    .dot.a{background: var(--aSoft); border-color: rgba(15,118,110,.25)}
    .dot.b{background: var(--bSoft); border-color: rgba(109,40,217,.25)}

    /* Sous-parties (accordéons) */
    details{border-top:1px solid var(--border)}
    summary{
      list-style:none;
      cursor:pointer;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
      background:#fff;
    }
    summary::-webkit-details-marker{display:none}
    .sumTitle{font-weight:900; font-size:18px}
    .chev{opacity:.65}
    details[open] summary{background:#fafafa}
    details[open] .chev{transform: rotate(180deg)}
    .topicBody{padding:0 16px 16px}

    /* Desktop: 2 colonnes */
    .compareGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 12px;
    }
    .colCard{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .colHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
      margin-bottom:10px;
    }
    .colName{font-weight:950; font-size:16px; margin:0}
    .colTag{font-size:14px; color:var(--muted); margin-top:2px}

    .items{display:flex; flex-direction:column; gap:10px}
    .item{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    .itemA{border-left: 5px solid rgba(15,118,110,.35); background: linear-gradient(90deg, rgba(204,251,241,.55), #fff 40%)}
    .itemB{border-left: 5px solid rgba(109,40,217,.35); background: linear-gradient(90deg, rgba(237,233,254,.65), #fff 40%)}

    .itemTitle{font-size:15px; font-weight:950; margin:0 0 6px}
    .itemText{font-size:17px; margin:0}
    .itemText p{margin:0}
    .src{margin-top:8px; font-size:14px; color:var(--muted)}
    .src a{color:inherit; text-decoration:underline; text-decoration-color: rgba(2,6,23,.25)}
    .src a:hover{text-decoration-color: rgba(2,6,23,.6)}

    /* Mobile: empiler + toggle */
    @media (max-width: 820px){
      .candRow{grid-template-columns:1fr}
      .compareGrid{grid-template-columns:1fr}
      .desktopOnly{display:none !important}
    }
    @media (min-width: 821px){
      .mobileOnly{display:none !important}
    }

    .singleView{display:grid; gap:12px; margin-top:12px}
    .rowCompare{
      border:1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    .rowHead{
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      border-bottom:1px solid var(--border);
      background: #f8fafc;
    }
    .rowHead strong{font-size:15px}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
    }
    .rowBody{padding:12px}
    .rowLabel{font-size:15px; font-weight:950; margin:0 0 6px}
    .rowText{font-size:17px}
    .rowText p{margin:0}

    .loading{color:var(--muted); font-size:17px}
    .footerNote{margin-top:18px; font-size:15px; color:var(--muted)}
    code{background:#f1f5f9; border:1px solid var(--border); padding:2px 6px; border-radius:8px}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1 id="pageTitle">Comparatif des candidatures</h1>
      <div class="sub" id="pageSub">Mobile : bascule A / B / Les deux • Desktop : côte à côte</div>
    </div>

    <div class="nav">
      <a class="chip" href="#equipes">Les équipes</a>
      <a class="chip" href="#programmes">Les programmes</a>
      <a class="chip" href="#financements">Les financements</a>

      <div class="seg" role="group" aria-label="Affichage mobile">
        <button id="btnBoth" aria-pressed="true">Les deux</button>
        <button id="btnA" aria-pressed="false">A</button>
        <button id="btnB" aria-pressed="false">B</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <div class="loading">Chargement des données…</div>
</main>

<script>
  /** ✅ Ton CSV Google Sheets publié */
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbr3kE4RckddIXPH8F2EGSWeGmHmCcTs2SNM-WqYUNV1NgcSNEr_kdl3N-RBolLFofzZfBMd4LnzyJ/pub?output=csv";

  const CANDIDATES = {
    A: { name: "Benoit Tirmarche", tag: "Wasquehal Vivante" },
    B: { name: "Stéphanie Ducret", tag: "Wasquehal pour Tous" }
  };

  /* 3 grandes parties (sans descriptions) */
  const PARTS = [
    { key: "equipes",       id: "equipes",       title: "Les équipes" },
    { key: "programmes",    id: "programmes",    title: "Les programmes" },
    { key: "financements",  id: "financements",  title: "Les financements" },
  ];

  let mobileMode = "both";

  function setPressed(id, pressed){
    document.getElementById(id).setAttribute("aria-pressed", pressed ? "true" : "false");
  }
  function setMobileMode(mode){
    mobileMode = mode;
    setPressed("btnBoth", mode==="both");
    setPressed("btnA", mode==="A");
    setPressed("btnB", mode==="B");
    render(window.__MODEL__);
  }
  document.getElementById("btnBoth").addEventListener("click", () => setMobileMode("both"));
  document.getElementById("btnA").addEventListener("click", () => setMobileMode("A"));
  document.getElementById("btnB").addEventListener("click", () => setMobileMode("B"));

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  /* Markdown autorisé dans les cellules candidatA/candidatB */
  function mdToHtml(s){ return marked.parse((s ?? "").toString()); }

  function srcHtml(sources){
  if(!sources) return "";

  // On laisse Markdown gérer listes, liens, retours ligne
  const html = marked.parse(sources.toString());

  return `
    <div class="src">
      <strong>Sources :</strong>
      <div class="srcList">${html}</div>
    </div>
  `;
}

  /* ✅ Rend le code compatible avec plusieurs libellés dans le CSV */
  function normalizePartKey(value){
    const v = (value || "").toString().trim().toLowerCase();

    // équipes
    if (["equipe","équipes","équipe","les équipes","les equipe","les equipes","equipes"].includes(v)) return "equipes";

    // programmes
    if (["programme","programmes","le programme","les programmes","programmes "].includes(v)) return "programmes";

    // financements (acceptons budget/moyens)
    if (["budget","moyen","moyens","les moyens","financement","financements","les financements","financements "].includes(v)) return "financements";

    // déjà bon ?
    if (["equipes","programmes","financements"].includes(v)) return v;

    return v;
  }

  /**
   * CSV attendu :
   * partie, sous_partie, item, candidatA, candidatB, sourceA, sourceB, ordre_sous_partie, ordre_item
   */
  function normalizeRow(r){
    return {
      partie: normalizePartKey(r.partie),
      sous_partie: (r.sous_partie || "").trim(),
      item: (r.item || "").trim(),
      candidatA: (r.candidatA || "").trim(),
      candidatB: (r.candidatB || "").trim(),
      sourceA: (r.sourceA || "").trim(),
      sourceB: (r.sourceB || "").trim(),
      ordre_sous_partie: num(r.ordre_sous_partie, 999),
      ordre_item: num(r.ordre_item, 999),
    };
  }

  function buildModel(rows){
    const partsMap = new Map();
    for(const p of PARTS){
      partsMap.set(p.key, { ...p, sous: new Map() });
    }

    for(const raw of rows){
      const r = normalizeRow(raw);
      if(!r.partie || !partsMap.has(r.partie)) continue;

      const part = partsMap.get(r.partie);
      const sp = r.sous_partie || "Divers";

      if(!part.sous.has(sp)){
        part.sous.set(sp, { title: sp, order: r.ordre_sous_partie, items: [] });
      }
      part.sous.get(sp).items.push({
        label: r.item || "Élément",
        order: r.ordre_item,
        A: { text: r.candidatA, source: r.sourceA },
        B: { text: r.candidatB, source: r.sourceB },
      });
    }

    const parts = PARTS.map(p => {
      const part = partsMap.get(p.key);
      const sousParts = Array.from(part.sous.values()).sort((a,b)=>{
        if(a.order !== b.order) return a.order - b.order;
        return a.title.localeCompare(b.title, "fr");
      });
      for(const sp of sousParts){
        sp.items.sort((a,b)=> a.order - b.order);
      }
      return { ...p, sousParts };
    });

    return {
      title: "Comparatif des candidatures",
      subtitle: "Mobile : bascule A / B / Les deux • Desktop : côte à côte",
      candidates: CANDIDATES,
      parts
    };
  }

  function render(model){
    const app = document.getElementById("app");
    if(!model){
      app.innerHTML = `<div class="loading">Aucune donnée.</div>`;
      return;
    }

    document.getElementById("pageTitle").textContent = model.title;
    document.getElementById("pageSub").textContent = model.subtitle;

    const {A, B} = model.candidates;

    const headerCards = `
      <div class="candRow">
        <div class="candCard candA">
          <div class="candHead">
            <div>
              <p class="candName">${esc(A.name)}</p>
              <div class="candList">${esc(A.tag)}</div>
            </div>
            <span class="badge">Candidat A</span>
          </div>
        </div>
        <div class="candCard candB">
          <div class="candHead">
            <div>
              <p class="candName">${esc(B.name)}</p>
              <div class="candList">${esc(B.tag)}</div>
            </div>
            <span class="badge">Candidate B</span>
          </div>
        </div>
      </div>
    `;

    const sectionsHtml = model.parts.map(part => {
      const sousHtml = (part.sousParts || []).map((sp, idx) => {
        const desktop = `
          <div class="compareGrid desktopOnly">
            <div class="colCard">
              <div class="colHead">
                <div>
                  <div class="colName" style="color:var(--a)">${esc(A.name)}</div>
                  <div class="colTag">${esc(A.tag)}</div>
                </div>
              </div>
              <div class="items">
                ${sp.items.map(it => `
                  <div class="item itemA">
                    <p class="itemTitle">${esc(it.label)}</p>
                    <div class="itemText">${mdToHtml(it.A?.text || "")}</div>
                    ${srcHtml(it.A?.source)}
                  </div>
                `).join("")}
              </div>
            </div>

            <div class="colCard">
              <div class="colHead">
                <div>
                  <div class="colName" style="color:var(--b)">${esc(B.name)}</div>
                  <div class="colTag">${esc(B.tag)}</div>
                </div>
              </div>
              <div class="items">
                ${sp.items.map(it => `
                  <div class="item itemB">
                    <p class="itemTitle">${esc(it.label)}</p>
                    <div class="itemText">${mdToHtml(it.B?.text || "")}</div>
                    ${srcHtml(it.B?.source)}
                  </div>
                `).join("")}
              </div>
            </div>
          </div>
        `;

        const mobileBoth = `
          <div class="singleView mobileOnly" data-mode="both">
            ${sp.items.map(it => `
              <div class="rowCompare">
                <div class="rowHead">
                  <strong>${esc(it.label)}</strong>
                  <span class="pill">Comparer</span>
                </div>
                <div class="rowBody" style="display:grid;gap:12px;">
                  <div>
                    <div class="rowLabel" style="color:var(--a)">${esc(A.name)}</div>
                    <div class="rowText">${mdToHtml(it.A?.text || "")}</div>
                    ${srcHtml(it.A?.source)}
                  </div>
                  <div>
                    <div class="rowLabel" style="color:var(--b)">${esc(B.name)}</div>
                    <div class="rowText">${mdToHtml(it.B?.text || "")}</div>
                    ${srcHtml(it.B?.source)}
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        const mobileSingle = (who) => {
          const name = who === "A" ? A.name : B.name;
          const color = who === "A" ? "var(--a)" : "var(--b)";
          return `
            <div class="singleView mobileOnly" data-mode="${who}">
              ${sp.items.map(it => `
                <div class="rowCompare">
                  <div class="rowHead">
                    <strong>${esc(it.label)}</strong>
                    <span class="pill">${esc(name)}</span>
                  </div>
                  <div class="rowBody">
                    <div class="rowLabel" style="color:${color}">${esc(name)}</div>
                    <div class="rowText">${mdToHtml((who==="A" ? it.A?.text : it.B?.text) || "")}</div>
                    ${srcHtml((who==="A" ? it.A?.source : it.B?.source) || "")}
                  </div>
                </div>
              `).join("")}
            </div>
          `;
        };

        const mobile = mobileMode === "both" ? mobileBoth : mobileSingle(mobileMode);

        return `
          <details ${idx===0 ? "open" : ""}>
            <summary>
              <div class="sumTitle">${esc(sp.title)}</div>
              <div class="chev">▾</div>
            </summary>
            <div class="topicBody">
              ${desktop}
              ${mobile}
            </div>
          </details>
        `;
      }).join("");

      return `
        <section class="section" id="${esc(part.id)}">
          <div class="sectionHead">
            <h2>${esc(part.title)}</h2>
            <div class="sectionMark" aria-hidden="true">
              <span class="dot a"></span><span class="dot b"></span>
            </div>
          </div>
          ${sousHtml || `<div style="padding:16px;color:var(--muted);font-size:17px">Aucun élément pour cette partie.</div>`}
        </section>
      `;
    }).join("");

    app.innerHTML = headerCards + sectionsHtml + `
      <div class="footerNote">
        Astuce : sur mobile, utilise “A / B / Les deux”. Les cellules <code>candidatA</code>/<code>candidatB</code> acceptent le Markdown (ex: <code>**gras**</code>, <code>[lien](https://...)</code>).
      </div>
    `;

    document.querySelectorAll('.mobileOnly[data-mode]').forEach(el => {
      el.style.display = (el.getAttribute('data-mode') === mobileMode) ? 'grid' : 'none';
    });
  }

  function loadFromCsv(){
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const rows = results.data || [];
        const model = buildModel(rows);
        window.__MODEL__ = model;
        render(model);
      },
      error: (err) => {
        document.getElementById("app").innerHTML = `
          <div class="loading">
            Erreur de chargement CSV.<br/>
            Vérifie que le lien est bien public et au format <b>pub?output=csv</b>.
            <div style="margin-top:10px;color:var(--muted)">${esc(err?.message || "")}</div>
          </div>`;
      }
    });
  }

  loadFromCsv();
</script>
</body>
</html>
