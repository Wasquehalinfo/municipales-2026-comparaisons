<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wasquehal 2026 - Comparatif des candidatures</title>

  <!-- CSV robuste + Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      /* Fond clair */
      --bg:#ffffff;
      --text:#0f172a;      /* slate-900 */
      --muted:#475569;     /* slate-600 */
      --border:#e2e8f0;    /* slate-200 */
      --card:#ffffff;

      /* Accents candidats (doux, non politisés) */
      --a:#0f766e;         /* teal-700 */
      --aSoft:#ccfbf1;     /* teal-100 */
      --b:#6d28d9;         /* violet-700 */
      --bSoft:#ede9fe;     /* violet-100 */

      /* Accents sections */
      --secSoft:#f1f5f9;   /* slate-100 */

      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
      --max:1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--text);
      line-height: 1.55;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }

    .topbar{
      max-width:var(--max);
      margin:0 auto;
      padding:16px 16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .title h1{
      margin:0;
      font-size: 22px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      font-size: 15px;
      color: var(--muted);
    }

    .nav{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      border:1px solid var(--border);
      background: #fff;
      padding:10px 12px;
      border-radius:999px;
      font-size: 15px;
      text-decoration:none;
      color: var(--text);
    }
    .chip:hover{background: #f8fafc}

    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background: #fff;
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      font-size: 15px;
      cursor:pointer;
    }
    .seg button[aria-pressed="true"]{
      background: #f1f5f9;
      font-weight: 750;
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:24px 16px 64px}

    /* ===== Édito ===== */
.edito{
  margin-bottom: 22px;
  padding: 18px 20px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: #f8fafc; /* très léger */
  box-shadow: var(--shadow);
}

.editoTitle{
  font-size: 18px;
  font-weight: 900;
  margin: 0 0 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.editoTitle span{
  font-size: 20px;
}

.editoText{
  font-size: 16px;
  color: var(--text);
}

.editoText p{
  margin: 0 0 8px;
}

.editoText p:last-child{
  margin-bottom: 0;
}

.editoText strong{
  font-weight: 800;
}

.editoText a{
  color: var(--text);
  text-decoration: underline;
  text-decoration-color: rgba(15,23,42,.35);
}
.editoText a:hover{
  text-decoration-color: rgba(15,23,42,.8);
}
    
    /* Cartes candidats */
    .candRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom: 18px;
    }
    .candCard{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .candHead{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .candName{font-size:18px; font-weight:900; margin:0}
    .candList{font-size:15px; color:var(--muted); margin-top:4px}
    .badge{
      font-size:12px;
      border:1px solid var(--border);
      padding:4px 10px;
      border-radius:999px;
      color: var(--muted);
      background: #fff;
      white-space:nowrap;
    }
    .candA{border-left: 6px solid var(--a)}
    .candB{border-left: 6px solid var(--b)}
    .candA .candName{color: var(--a)}
    .candB .candName{color: var(--b)}

    /* Grande section */
    .section{
      margin-top:18px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--card);
    }
    .sectionHead{
      padding:18px 16px;
      border-bottom:1px solid var(--border);
      background: var(--secSoft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sectionHead h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sectionMark{
      display:flex; gap:8px; align-items:center;
      font-size:13px; color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(2,6,23,.1);
    }
    .dot.a{background: var(--aSoft); border-color: rgba(15,118,110,.25)}
    .dot.b{background: var(--bSoft); border-color: rgba(109,40,217,.25)}

    /* Sous-parties (accordéons) */
    details{border-top:1px solid var(--border)}
    /* Pour que le scroll se cale bien sous le header sticky */
    details{ scroll-margin-top: 96px; }
    summary{ scroll-margin-top: 96px; }
    summary{
      list-style:none;
      cursor:pointer;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
      background:#fff;
    }
    summary::-webkit-details-marker{display:none}
    .sumTitle{font-weight:900; font-size:18px}
    .chev{opacity:.65}
    details[open] summary{background:#fafafa}
    details[open] .chev{transform: rotate(180deg)}
    .topicBody{padding:0 16px 16px}

    /* ======= NOUVEAU : desktop en lignes A/B (hauteurs identiques) ======= */
    .desktopCompareHead{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }

    .rowGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .rowCell{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Cartes / items */
    .colCard{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .colHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
      margin-bottom:10px;
    }
    .colName{font-weight:950; font-size:16px; margin:0}
    .colTag{font-size:14px; color:var(--muted); margin-top:2px}

    .item{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    .itemA{border-left: 5px solid rgba(15,118,110,.35); background: linear-gradient(90deg, rgba(204,251,241,.55), #fff 40%)}
    .itemB{border-left: 5px solid rgba(109,40,217,.35); background: linear-gradient(90deg, rgba(237,233,254,.65), #fff 40%)}

    .itemTitle{font-size:15px; font-weight:950; margin:0 0 6px}
    .itemText{font-size:17px}
    .itemText p{margin:0}

    /* Sources : très discret + lien1, lien2... */
    .src{
      margin-top:10px;
      padding-top:8px;
      border-top:1px dashed rgba(2,6,23,.10);
      font-size:12px;
      color: rgba(71,85,105,.72);
    }
    .src strong{
      color: rgba(71,85,105,.72);
      font-weight:650;
    }
    .srcLinks{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .src a{
      font-size:12px;
      color: rgba(71,85,105,.72);
      text-decoration:underline;
      text-decoration-color: rgba(71,85,105,.30);
    }
    .src a:hover{
      color: rgba(71,85,105,.95);
      text-decoration-color: rgba(71,85,105,.70);
    }

    /* Mobile: empiler + toggle */
    @media (max-width: 820px){
      .candRow{grid-template-columns:1fr}
      .desktopOnly{display:none !important}
    }
    @media (min-width: 821px){
      .mobileOnly{display:none !important}
    }

    .singleView{display:grid; gap:12px; margin-top:12px}
    .rowCompare{
      border:1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    .rowHead{
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      border-bottom:1px solid var(--border);
      background: #f8fafc;
    }
    .rowHead strong{font-size:15px}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
    }
    .rowBody{padding:12px}
    .rowLabel{font-size:15px; font-weight:950; margin:0 0 6px}
    .rowText{font-size:17px}
    .rowText p{margin:0}

    .loading{color:var(--muted); font-size:17px}

    /* ===== Amélioration lisibilité titres items (mobile) ===== */
@media (max-width: 820px){

  .rowHead{
    background: #eef2f7;              /* fond plus clair */
    border-bottom: 2px solid var(--border);
    padding: 14px 14px;
  }

  .rowHead strong{
    font-size: 17px;                  /* plus grand */
    font-weight: 900;                 /* plus gras */
    color: var(--text);
    line-height: 1.35;
  }

  /* Accent visuel à gauche du titre */
  .rowHead::before{
    content:"";
    display:block;
    width:4px;
    background: linear-gradient(
      to bottom,
      var(--a),
      var(--b)
    );
    border-radius: 4px;
    margin-right: 10px;
  }

  .rowHead{
    display:flex;
    align-items:flex-start;
    gap:10px;
  }
}
    
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1 id="pageTitle">Comparatif des candidatures</h1>
      <div class="sub" id="pageSub"></div>
    </div>

    <div class="nav">
      <a class="chip" href="#equipes">Les équipes</a>
      <a class="chip" href="#programmes">Les programmes</a>
      <a class="chip" href="#financements">Les financements</a>

      <div class="seg" role="group" aria-label="Affichage mobile">
        <button id="btnBoth" aria-pressed="true">Les deux</button>
        <button id="btnA" aria-pressed="false">A</button>
        <button id="btnB" aria-pressed="false">B</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <div class="loading">Chargement des données…</div>
</main>

<script>
  /** ✅ Ton CSV Google Sheets publié */
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbr3kE4RckddIXPH8F2EGSWeGmHmCcTs2SNM-WqYUNV1NgcSNEr_kdl3N-RBolLFofzZfBMd4LnzyJ/pub?output=csv";

  const CANDIDATES = {
    A: { name: "Benoit Tirmarche", tag: "Wasquehal Vivante" },
    B: { name: "Stéphanie Ducret", tag: "Wasquehal pour Tous" }
  };

  /* 3 grandes parties */
  const PARTS = [
    { key: "equipes",       id: "equipes",       title: "Les équipes" },
    { key: "programmes",    id: "programmes",    title: "Les programmes" },
    { key: "financements",  id: "financements",  title: "Les financements" },
  ];

  // Sécurité : on n'autorise pas de HTML brut dans le Markdown
  marked.setOptions({ mangle: false, headerIds: false });

const renderer = new marked.Renderer();

// Désactive le HTML brut (sécurité)
renderer.html = () => "";

// Force target="_blank" sur TOUS les liens Markdown
renderer.link = function(href, title, text) {
  const safeHref = href || "";
  const safeTitle = title ? ` title="${title}"` : "";
  return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer"${safeTitle}>${text}</a>`;
};

marked.use({ renderer });

  let mobileMode = "both";

  function setPressed(id, pressed){
    document.getElementById(id).setAttribute("aria-pressed", pressed ? "true" : "false");
  }
  function setMobileMode(mode){
    mobileMode = mode;
    setPressed("btnBoth", mode==="both");
    setPressed("btnA", mode==="A");
    setPressed("btnB", mode==="B");
    render(window.__MODEL__);
  }
  document.getElementById("btnBoth").addEventListener("click", () => setMobileMode("both"));
  document.getElementById("btnA").addEventListener("click", () => setMobileMode("A"));
  document.getElementById("btnB").addEventListener("click", () => setMobileMode("B"));

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function mdToHtml(s){ return marked.parse((s ?? "").toString()); }

  function extractUrls(text){
    const t = (text ?? "").toString();
    const re = /https?:\/\/[^\s\)\]\}>,"]+/g;
    return (t.match(re) || []).map(u => u.trim());
  }

  function srcHtml(sources){
    const raw = (sources ?? "").toString().trim();
    if(!raw) return "";

    const urls = extractUrls(raw);
    if(urls.length === 0) return "";

    const links = urls.map((u, i) => {
      const safe = esc(u).replaceAll('"',"&quot;");
      return `<a href="${safe}" target="_blank" rel="noopener">lien${i+1}</a>`;
    }).join("");

    return `
      <div class="src">
        <strong>Sources :</strong>
        <div class="srcLinks">${links}</div>
      </div>
    `;
  }

  function num(x, fallback=999){
    const n = parseFloat((x ?? "").toString().replace(",", "."));
    return Number.isFinite(n) ? n : fallback;
  }

  function normalizePartKey(value){
    const v = (value || "").toString().trim().toLowerCase();

    if (["equipe","équipes","équipe","les équipes","les equipe","les equipes","equipes"].includes(v)) return "equipes";
    if (["programme","programmes","le programme","les programmes","programmes "].includes(v)) return "programmes";
    if (["budget","moyen","moyens","les moyens","financement","financements","les financements","financements "].includes(v)) return "financements";
    if (["equipes","programmes","financements"].includes(v)) return v;

    return v;
  }

  function normalizeRow(r){
    return {
      partie: normalizePartKey(r.partie),
      sous_partie: (r.sous_partie || "").trim(),
      item: (r.item || "").trim(),
      candidatA: (r.candidatA || "").trim(),
      candidatB: (r.candidatB || "").trim(),
      sourceA: (r.sourceA || "").trim(),
      sourceB: (r.sourceB || "").trim(),
      ordre_sous_partie: num(r.ordre_sous_partie, 999),
      ordre_item: num(r.ordre_item, 999),
    };
  }

  function buildModel(rows){
    const partsMap = new Map();
    for(const p of PARTS){
      partsMap.set(p.key, { ...p, sous: new Map() });
    }

    for(const raw of rows){
      const r = normalizeRow(raw);
      if(!r.partie || !partsMap.has(r.partie)) continue;

      const part = partsMap.get(r.partie);
      const sp = r.sous_partie || "Divers";

      if(!part.sous.has(sp)){
        part.sous.set(sp, { title: sp, order: r.ordre_sous_partie, items: [] });
      }
      part.sous.get(sp).items.push({
        label: r.item || "Élément",
        order: r.ordre_item,
        A: { text: r.candidatA, sources: r.sourceA },
        B: { text: r.candidatB, sources: r.sourceB },
      });
    }

    const parts = PARTS.map(p => {
      const part = partsMap.get(p.key);
      const sousParts = Array.from(part.sous.values()).sort((a,b)=>{
        if(a.order !== b.order) return a.order - b.order;
        return a.title.localeCompare(b.title, "fr");
      });
      for(const sp of sousParts){
        sp.items.sort((a,b)=> a.order - b.order);
      }
      return { ...p, sousParts };
    });

    return {
      title: "Wasquehal 2026 - Comparatif des candidatures",
      subtitle: "",
      candidates: CANDIDATES,
      parts
    };
  }

  // ✅ NOUVEAU : accordéon exclusif (un seul <details> ouvert à la fois)
  function setupExclusiveAccordion(){
  const header = document.querySelector("header");

  function headerOffset(){
    // hauteur du header sticky + petite marge
    const h = header ? header.getBoundingClientRect().height : 0;
    return Math.round(h + 12);
  }

  function scrollToDetailsTop(detailsEl){
    const y = window.scrollY + detailsEl.getBoundingClientRect().top - headerOffset();
    window.scrollTo({ top: y, behavior: "smooth" });
  }

  const all = Array.from(document.querySelectorAll("details"));

  all.forEach(d => {
    d.addEventListener("toggle", () => {
      if (!d.open) return;

      // Ferme les autres d'abord
      for (const other of all) {
        if (other !== d) other.open = false;
      }

      // Puis, après que le layout se soit recalculé, on se repositionne
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          scrollToDetailsTop(d);
        });
      });
    });
  });
}

  function render(model){
    const app = document.getElementById("app");
    if(!model){
      app.innerHTML = `<div class="loading">Aucune donnée.</div>`;
      return;
    }

    document.getElementById("pageTitle").textContent = model.title;
    document.getElementById("pageSub").textContent = model.subtitle;

    const {A, B} = model.candidates;

    const edito = `
  <section class="edito">
    <h2 class="editoTitle">
      <span aria-hidden="true">ℹ️</span>
      Édito
    </h2>
    <div class="editoText">
      <p>
        La comparaison des candidatures est réalisée uniquement à partir des écrits des candidates et candidats.
        Des erreurs peuvent apparaître ; n’hésitez pas à nous les signaler à l’adresse
        <strong><a href="mailto:studiowasquehal@gmail.com">studiowasquehal@gmail.com</a></strong>.
      </p>
      <p>
        Cette initiative se veut participative et la plus factuelle possible afin d’aider au mieux
        les Wasquehaliennes et les Wasquehaliens à choisir leur future ou futur maire le
        <strong>dimanche 15 mars prochain</strong>.
      </p>
    </div>
  </section>
`;
    
    const headerCards = `
      <div class="candRow">
        <div class="candCard candA">
          <div class="candHead">
            <div>
              <p class="candName">${esc(A.name)}</p>
              <div class="candList">${esc(A.tag)}</div>
            </div>
            <span class="badge">Candidat A</span>
          </div>
        </div>
        <div class="candCard candB">
          <div class="candHead">
            <div>
              <p class="candName">${esc(B.name)}</p>
              <div class="candList">${esc(B.tag)}</div>
            </div>
            <span class="badge">Candidate B</span>
          </div>
        </div>
      </div>
    `;

    const sectionsHtml = model.parts.map(part => {
      const sousHtml = (part.sousParts || []).map((sp) => {

        // ✅ Desktop : ligne par item (A | B) => hauteurs identiques
        const desktop = `
          <div class="desktopOnly">
            <div class="desktopCompareHead">
              <div class="colCard">
                <div class="colHead" style="margin-bottom:0;border-bottom:0;padding-bottom:0;">
                  <div>
                    <div class="colName" style="color:var(--a)">${esc(A.name)}</div>
                    <div class="colTag">${esc(A.tag)}</div>
                  </div>
                </div>
              </div>
              <div class="colCard">
                <div class="colHead" style="margin-bottom:0;border-bottom:0;padding-bottom:0;">
                  <div>
                    <div class="colName" style="color:var(--b)">${esc(B.name)}</div>
                    <div class="colTag">${esc(B.tag)}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="rowGrid">
              ${sp.items.map(it => `
                <div class="rowCell item itemA">
                  <p class="itemTitle">${esc(it.label)}</p>
                  <div class="itemText">${mdToHtml(it.A?.text || "")}</div>
                  ${srcHtml(it.A?.sources || "")}
                </div>

                <div class="rowCell item itemB">
                  <p class="itemTitle">${esc(it.label)}</p>
                  <div class="itemText">${mdToHtml(it.B?.text || "")}</div>
                  ${srcHtml(it.B?.sources || "")}
                </div>
              `).join("")}
            </div>
          </div>
        `;

        // Mobile : on conserve ton rendu
        const mobileBoth = `
          <div class="singleView mobileOnly" data-mode="both">
            ${sp.items.map(it => `
              <div class="rowCompare">
                <div class="rowHead">
                  <strong>${esc(it.label)}</strong>
                 
                </div>
                <div class="rowBody" style="display:grid;gap:12px;">
                  <div>
                    <div class="rowLabel" style="color:var(--a)">${esc(A.name)}</div>
                    <div class="rowText">${mdToHtml(it.A?.text || "")}</div>
                    ${srcHtml(it.A?.sources || "")}
                  </div>
                  <div>
                    <div class="rowLabel" style="color:var(--b)">${esc(B.name)}</div>
                    <div class="rowText">${mdToHtml(it.B?.text || "")}</div>
                    ${srcHtml(it.B?.sources || "")}
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        const mobileSingle = (who) => {
          const name = who === "A" ? A.name : B.name;
          const color = who === "A" ? "var(--a)" : "var(--b)";
          return `
            <div class="singleView mobileOnly" data-mode="${who}">
              ${sp.items.map(it => `
                <div class="rowCompare">
                  <div class="rowHead">
                    <strong>${esc(it.label)}</strong>
                    <span class="pill">${esc(name)}</span>
                  </div>
                  <div class="rowBody">
                    <div class="rowLabel" style="color:${color}">${esc(name)}</div>
                    <div class="rowText">${mdToHtml((who==="A" ? it.A?.text : it.B?.text) || "")}</div>
                    ${srcHtml((who==="A" ? it.A?.sources : it.B?.sources) || "")}
                  </div>
                </div>
              `).join("")}
            </div>
          `;
        };

        const mobile = mobileMode === "both" ? mobileBoth : mobileSingle(mobileMode);

        return `
          <details>
            <summary>
              <div class="sumTitle">${esc(sp.title)}</div>
              <div class="chev">▾</div>
            </summary>
            <div class="topicBody">
              ${desktop}
              ${mobile}
            </div>
          </details>
        `;
      }).join("");

      return `
        <section class="section" id="${esc(part.id)}">
          <div class="sectionHead">
            <h2>${esc(part.title)}</h2>
            <div class="sectionMark" aria-hidden="true">
              <span class="dot a"></span><span class="dot b"></span>
            </div>
          </div>
          ${sousHtml || `<div style="padding:16px;color:var(--muted);font-size:17px">Aucun élément pour cette partie.</div>`}
        </section>
      `;
    }).join("");

    app.innerHTML = edito + headerCards + sectionsHtml;

    // Mode mobile (affiche le bon bloc)
    document.querySelectorAll('.mobileOnly[data-mode]').forEach(el => {
      el.style.display = (el.getAttribute('data-mode') === mobileMode) ? 'grid' : 'none';
    });

    // ✅ Accordeon exclusif
    setupExclusiveAccordion();
  }

  function loadFromCsv(){
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const rows = results.data || [];
        const model = buildModel(rows);
        window.__MODEL__ = model;
        render(model);
      },
      error: (err) => {
        document.getElementById("app").innerHTML = `
          <div class="loading">
            Erreur de chargement CSV.<br/>
            Vérifie que le lien est bien public et au format <b>pub?output=csv</b>.
            <div style="margin-top:10px;color:var(--muted)">${esc(err?.message || "")}</div>
          </div>`;
      }
    });
  }

  loadFromCsv();
</script>
</body>
</html>
